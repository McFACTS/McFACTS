#!/usr/bin/env python3
"""Test for circular_singles_encounters_prograde function
    in physics/dynamics.py
"""
######## Imports ########
#### Standard Library ####
import time
#### Third-Party ####
import numpy as np
#### Homemade ####
#### Local ####
from mcfacts.physics.dynamics import circular_singles_encounters_prograde

######## Setup ########
INPUT_DATA = {
    "smbh_mass" : 100000000.0,
    "timestep_duration_yr" : 10000.0,
    "disk_bh_pro_orb_ecc_crit": 0.01,
    "delta_energy_strong": 0.1,
    "disk_radius_outer": 50000.0,
    "disk_bh_pro_orbs_a" :  np.asarray(
    [35172.36470036, 21841.5012635,  29606.77708478, 49800.52374052,
 43688.1012061,  42082.79226079, 34121.46470106, 34561.13744514,
  9807.37203311, 18349.13183393, 35383.13961514, 47386.56103656,
 44636.83829284,  9454.69383481, 28395.67122367,   294.4006048,
 26274.32369432, 40561.07336707,  8601.13654886, 26043.48609589,
 49974.15307615, 49883.38868661, 23033.97427077, 24413.41024101,
  4506.70708101, 38557.41183141, 46312.73883674, 14472.25823726,
 28856.81634082, 34738.79123039, 37759.25682326, 16891.44039144,
 17892.34619795,  4391.42579991, 31882.10628811, 18209.03357903,
  1177.90109248, 17197.21036477, 39226.13224413,  6891.51089019,
 37232.51951252, 45172.97448497, 49500.10949411, 18543.64375564,
 15647.68841569, 10693.42804343, 17611.2047292,  15215.47992608,
  7625.85289213, 30194.55713056, 10007.99027027, 45826.94665295,
 11886.91536572, 35103.62288162, 10010.00938001,  6845.0032109,
 29358.80659681, 42760.41161441, 34409.00555101, 25766.43414043,
  6331.28727189, 25245.7961038,  10020.74317394, 33523.46094346,
 33238.69483469,  1933.23964061, 42839.25223125, 21200.42756043,
 37456.69283269, 48509.17742918, 18341.26784127, 18840.26352506,
 47750.76769077, 40252.45727264, 20785.27696928, 10949.8975199,
 12573.86931547, 29304.01311801, 19417.93970194, 19949.92638793,
 22662.63860784, 10374.10111912, 14790.71047971, 29706.86010206,
 31359.76845377, 15611.14276514, 28821.07059507,   419.36008768,
 18285.03433501, 16849.08379738, 25746.52010603, 36312.39805863,
  7305.34973218, 32750.80261779, 25334.83119512, 24072.02520612,
 31009.55159394, 22314.72165523, 19772.40595743, 31353.30019858,
 29766.30384552, 22643.06245436, 39773.67052252, 43063.21227264,
 33993.41841432, 41199.50961043, 29318.92518475,  5366.7601699,
 32196.60982893, 11083.57679201, 37756.19874412, 35470.14836781,
 38917.20041713, 29559.2248061,  29953.35310514, 11757.31837722,
 31919.06367749,  8815.65545283, 29742.73410207, 20727.51346774,
 30394.53448293, 16889.34863534, 14148.1851971,   5806.62356549,
 11902.19064763, 38037.67749438, 33996.12991842,  5639.80802594,
  6135.45524421,  3108.76693023, 17836.20439694, 32787.22534199,
  9979.83094604, 21044.31384229, 29178.78655441, 13259.83062645,]),
  "disk_bh_pro_masses" : np.asarray(
  [29.39713947, 17.00534016, 33.60887498, 22.86432679, 37.37192186, 12.09552025,
 14.52440779, 35.39366794, 19.90723665, 20.62275915, 10.61712502, 16.20426944,
 17.04654148, 17.75421274, 19.43663768, 12.66684221, 13.05984494, 10.75567965,
 12.29283713, 20.0244305,  19.82323288, 12.04214564, 12.79924781, 28.39945277,
 14.1787523,  15.68911987, 11.42793887, 12.82692717, 17.1120764,  16.68387342,
 11.69761137, 11.44934945, 11.04026522, 12.93527167, 15.70342081, 24.71699487,
 33.70202821, 11.95459366, 35.37083369, 10.38377674, 14.24486672, 14.03697996,
 13.36519061, 10.57990874, 15.77606971, 14.55859813, 10.13885336, 13.5122694,
 13.49845674, 37.26105224, 18.15219537, 36.47082841, 10.33023898, 14.30988085,
 11.31866577, 20.76820674, 13.83769033, 22.58607841, 23.92986857, 27.08432568,
 13.44060613, 20.881481,   11.47069179, 22.56803383, 12.26700196, 10.68854151,
 13.02924851, 24.14000047, 13.62797376, 11.89694073, 33.6214865,  16.08353119,
 11.64541406, 14.35155009, 26.08273385, 13.56764076, 12.56140987, 10.6400257,
 20.25961962, 31.57321243, 34.85895169, 13.85041586, 21.84634123, 38.2160151,
 10.92336337, 11.1111769,  11.39464349, 10.10311772, 11.78423542, 14.22989221,
 14.97085044, 14.52306915, 10.35601661, 18.03319557, 10.608047,   37.21723859,
 11.56842845, 34.18279788, 18.93872657, 16.73691521, 16.20173276, 31.91932471,
 10.38551808, 10.2147633,  12.40354323, 10.99624759, 35.6381393,  10.90717105,
 13.22852089, 18.59149833, 13.46778679, 10.32762599, 17.51498405, 24.08692471,
 11.46367888, 34.62305701, 10.2415544,  21.96637551, 13.16615992, 16.06764921,
 35.96147889, 16.29213154, 15.55739366, 10.34960583, 11.56074837, 20.15133335,
 17.67936782, 17.23548737, 10.53249897, 10.82385445, 13.15856488, 12.68594544,
 10.98832215, 26.47677191, 14.54910291, 30.78966804]),
    "disk_bh_pro_orbs_ecc" : np.asarray(
    [0.01137295, 0.01248925, 0.05630263, 0.09365657, 0.18897722, 0.04216794,
 0.19450047, 0.12159871, 0.1,        0.1814434,  0.01644095, 0.27944384,
 0.08452198, 0.2037242,  0.14504789, 0.18197932, 0.25580469, 0.06931141,
 0.1,        0.20347967, 0.1414552,  0.1,        0.22028833, 0.0793246,
 0.01,       0.26761587, 0.04769995, 0.23368825, 0.11843704, 0.08984752,
 0.05680836, 0.26738967, 0.20663963, 0.01,       0.10371069, 0.09807832,
 0.01,       0.18595839, 0.18251905, 0.11617699, 0.07296272, 0.12117097,
 0.03272839, 0.23979771, 0.24031864, 0.010487,   0.06499208, 0.04531761,
 0.01,       0.08676289, 0.01,       0.08158351, 0.1793872,  0.18780148,
 0.01,       0.01869673, 0.2680296,  0.09592085, 0.20304755, 0.01098656,
 0.02972812, 0.01264171, 0.01341677, 0.17628894, 0.01197342, 0.01,
 0.16630883, 0.01365884, 0.19525014, 0.10488849, 0.01,       0.05748299,
 0.24785271, 0.08674205, 0.26767091, 0.12207637, 0.06747427, 0.23790518,
 0.08847284, 0.23513561, 0.07132912, 0.01,       0.02209179, 0.14110134,
 0.05288274, 0.13507653, 0.02289019, 0.08603258, 0.0655866,  0.03100378,
 0.07004791, 0.08759408, 0.5286042,  0.89966238, 0.80972528, 0.8989122,
 0.72879367, 0.99897552, 0.9993231,  0.99969396, 0.9996806,  0.99906353,
 0.99986532, 0.99988185, 0.99979823, 0.99986445, 0.99928169, 0.99734654,
 0.99976723, 0.99844843, 0.99981174, 0.99984202, 0.09577914, 0.99952028,
 0.99977605, 0.9973489,  0.99981752, 0.01,       0.99974015, 0.99946393,
 0.99931205, 0.99926698, 0.99909284, 0.99775947, 0.99913137, 0.9997213,
 0.99971244, 0.99610118, 0.01,       0.01,       0.08074296, 0.01,
 0.01,       0.01,       0.01,       0.01,      ]),
}

OUTPUT_DATA = {
    "disk_bh_pro_orbs_a": np.asarray(
    [35172.36470036, 21841.5012635,  29606.77708478, 49800.52374052,
 43688.1012061,  42082.79226079, 34121.46470106, 34561.13744514,
  7149.57421214, 16514.21865054, 35383.13961514, 47386.56103656,
 44636.83829284,  9454.69383481, 28395.67122367,   294.4006048,
 26274.32369432, 40561.07336707,  8601.13654886, 26043.48609589,
 49974.15307615, 49883.38868661, 23033.97427077, 24413.41024101,
  4957.37778911, 34701.67064827, 46312.73883674, 14472.25823726,
 28856.81634082, 34738.79123039, 37759.25682326, 16891.44039144,
 17892.34619795,  4830.5683799,  31882.10628811, 18209.03357903,
  1295.69120173, 17197.21036477, 39226.13224413,  6202.35980117,
 37232.51951252, 45172.97448497, 49500.10949411, 18543.64375564,
 15647.68841569, 10693.42804343, 17611.2047292,  15215.47992608,
  8388.43818134, 30194.55713056, 11008.7892973,  45826.94665295,
 10698.22382915, 35103.62288162, 11011.01031801,  6845.0032109,
 29358.80659681, 42760.41161441, 34409.00555101, 25766.43414043,
  6331.28727189, 25245.7961038,  10020.74317394, 30171.11484911,
 33238.69483469,  2126.56360467, 42839.25223125, 21200.42756043,
 37456.69283269, 48509.17742918, 20175.3946254,  18840.26352506,
 47750.76769077, 40252.45727264, 20785.27696928, 10949.8975199,
 11316.48238392, 29304.01311801, 19417.93970194, 19949.92638793,
 22662.63860784, 11411.51123103, 14790.71047971, 29706.86010206,
 31359.76845377, 15611.14276514, 28821.07059507,   419.36008768,
 18285.03433501, 16849.08379738, 25746.52010603, 36312.39805863,
  5917.33328307, 29475.72235601, 22801.34807561, 19498.34041696,
 31009.55159394, 18074.92454074, 19772.40595743, 31353.30019858,
 29766.30384552, 22643.06245436, 39773.67052252, 43063.21227264,
 33993.41841432, 41199.50961043, 29318.92518475,  5366.7601699,
 32196.60982893, 11083.57679201, 37756.19874412, 35470.14836781,
 38917.20041713, 29559.2248061,  29953.35310514, 11757.31837722,
 31919.06367749,  9697.22099811, 29742.73410207, 20727.51346774,
 30394.53448293, 16889.34863534, 14148.1851971,   5806.62356549,
 11902.19064763, 38037.67749438, 33996.12991842,  5639.80802594,
  6749.00076863,  3419.64362325, 17836.20439694, 36065.94787619,
 10977.81404064, 23148.74522652, 32096.66520985, 14585.8136891, ]),
    "disk_bh_pro_orbs_ecc" : np.asarray(
    [0.01137295, 0.01248925, 0.05630263, 0.09365657, 0.18897722, 0.04216794,
 0.19450047, 0.12159871, 0.0729,     0.16329906, 0.01644095, 0.27944384,
 0.08452198, 0.2037242,  0.14504789, 0.18197932, 0.25580469, 0.06931141,
 0.1,        0.20347967, 0.1414552,  0.1,        0.22028833, 0.0793246,
 0.1,        0.24085428, 0.04769995, 0.23368825, 0.11843704, 0.08984752,
 0.05680836, 0.26738967, 0.20663963, 0.1,        0.10371069, 0.09807832,
 0.1,        0.18595839, 0.18251905, 0.10455929, 0.07296272, 0.12117097,
 0.03272839, 0.23979771, 0.24031864, 0.010487,   0.06499208, 0.04531761,
 0.1,        0.08676289, 0.1,        0.08158351, 0.16144848, 0.18780148,
 0.1,        0.01869673, 0.2680296,  0.09592085, 0.20304755, 0.01098656,
 0.02972812, 0.01264171, 0.01341677, 0.15866005, 0.01197342, 0.1,
 0.16630883, 0.01365884, 0.19525014, 0.10488849, 0.1,        0.05748299,
 0.24785271, 0.08674205, 0.26767091, 0.12207637, 0.06072684, 0.23790518,
 0.08847284, 0.23513561, 0.07132912, 0.1,        0.02209179, 0.14110134,
 0.05288274, 0.13507653, 0.02289019, 0.08603258, 0.0655866,  0.03100378,
 0.07004791, 0.08759408, 0.4281694,  0.80969614, 0.72875275, 0.72811888,
 0.72879367, 0.80917017, 0.9993231,  0.99969396, 0.9996806,  0.99906353,
 0.99986532, 0.99988185, 0.99979823, 0.99986445, 0.99928169, 0.99734654,
 0.99976723, 0.99844843, 0.99981174, 0.99984202, 0.09577914, 0.99952028,
 0.99977605, 0.9973489,  0.99981752, 0.1,        0.99974015, 0.99946393,
 0.99931205, 0.99926698, 0.99909284, 0.99775947, 0.99913137, 0.9997213,
 0.99971244, 0.99610118, 0.1,        0.1,        0.08074296, 0.1,
 0.1,        0.1,        0.1,        0.1,       ]),
}

######## Functions ########

######## Tests ########
def test_inputs():
    for key in INPUT_DATA:
        print(key)
    for key in OUTPUT_DATA:
        print(key)
        assert not np.allclose(INPUT_DATA[key],OUTPUT_DATA[key]), \
            "test circular_singles_encounter_prograde: Bad OUTPUT DATA\n" +\
            "All input and output values are identical"

def test_circ_singles_encounters_prograde():
    tic = time.perf_counter()
    (disk_bh_pro_orbs_a, disk_bh_pro_orbs_ecc) = \
        circular_singles_encounters_prograde(
            INPUT_DATA["smbh_mass"],
            INPUT_DATA["disk_bh_pro_orbs_a"].copy(),
            INPUT_DATA["disk_bh_pro_masses"].copy(),
            INPUT_DATA["disk_bh_pro_orbs_ecc"].copy(),
            INPUT_DATA["timestep_duration_yr"],
            INPUT_DATA["disk_bh_pro_orb_ecc_crit"],
            INPUT_DATA["delta_energy_strong"],
            INPUT_DATA["disk_radius_outer"],
    )
    toc = time.perf_counter()
    assert np.allclose(disk_bh_pro_orbs_a, OUTPUT_DATA["disk_bh_pro_orbs_a"]), \
            "test circular_singles_encounter_prograde: OUTPUT_DATA mismatch"
    assert np.allclose(disk_bh_pro_orbs_ecc, OUTPUT_DATA["disk_bh_pro_orbs_ecc"]), \
            "test circular_singles_encounter_prograde: OUTPUT_DATA mismatch"
    print("test_circular_singlues_encounters_prograde: pass")
    diff_mask = ~(np.isclose(disk_bh_pro_orbs_a, INPUT_DATA["disk_bh_pro_orbs_a"]) & np.isclose(disk_bh_pro_orbs_ecc, INPUT_DATA["disk_bh_pro_orbs_ecc"]))


######## Algorithm ########
def tests():
    test_inputs()
    test_circ_singles_encounters_prograde()
######## Main ########
def main():
    tests()
    return
######## Execution ########
if __name__ == "__main__":
    main()
